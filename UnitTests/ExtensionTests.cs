using Mars.Clouds.Extensions;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using System;

namespace Mars.Clouds.UnitTests
{
    [TestClass]
    public class ExtensionTests
    {
        [TestMethod]
        public void Int64()
        {
            Int64 minMin = Int64Extensions.Pack(Int32.MinValue, Int32.MinValue);
            Int64 minMax = Int64Extensions.Pack(Int32.MinValue, Int32.MaxValue);
            Int64 zeroZero = Int64Extensions.Pack(0, 0);
            Int64 maxMin = Int64Extensions.Pack(Int32.MaxValue, Int32.MinValue);
            Int64 maxMax = Int64Extensions.Pack(Int32.MaxValue, Int32.MaxValue);

            Assert.IsTrue((minMin.GetUpperInt32() == Int32.MinValue) && (minMin.GetLowerInt32() == Int32.MinValue));
            Assert.IsTrue((minMax.GetUpperInt32() == Int32.MinValue) && (minMax.GetLowerInt32() == Int32.MaxValue));
            Assert.IsTrue((zeroZero.GetUpperInt32() == 0) && (zeroZero.GetLowerInt32() == 0));
            Assert.IsTrue((maxMin.GetUpperInt32() == Int32.MaxValue) && (maxMin.GetLowerInt32() == Int32.MinValue));
            Assert.IsTrue((maxMax.GetUpperInt32() == Int32.MaxValue) && (maxMax.GetLowerInt32() == Int32.MaxValue));
        }

        [TestMethod]
        public void Sort()
        {
            // sequential z and intensity values from Elliott 2021 LiDAR flight, sampled from random start on tile s04200w06660
            #region input data
            Int32[] z = [ 81227, 89032, 81253, 88970, 88009, 81175, 90043, 88898, 87907, 88806, 88747, 88064, 89701, 89314, 89298, 88245, 81188, 81178, 81227, 85705, 81191, 81070,
                          81066, 87730, 81037, 87756, 81027, 87815, 81047, 88806, 87854, 81207, 90102, 81158, 90026, 89675, 89944, 89623, 89705, 89692, 88474, 89409, 88488, 88934,
                          89462, 89537, 88960, 89567, 89131, 89186, 89167, 88409, 88100, 88281, 88061, 80965, 88081, 87684, 80919, 87723, 80932, 87759, 85843, 80945, 87782, 86585,
                          80922, 84741, 84049, 81093, 88228, 81083, 83484, 81083, 81096, 84035, 82618, 81027, 80850, 86142, 85594, 85000, 80846, 80860, 86614, 80873, 87631, 84977,
                          81155, 80853, 87559, 84518, 80843, 88051, 84521, 81503, 80843, 80810, 84144, 80807, 83025, 80801, 83028, 80810, 83186, 82497, 80863, 87605, 83064, 82313,
                          80843, 82287, 80781, 82257, 81841, 80784, 81808, 80781, 81844, 81217, 81306, 80981, 81007, 86260, 81070, 81024, 81155, 81188, 81161, 81135, 80768, 80722,
                          81112, 80702, 82707, 81076, 80702, 82736, 82756, 82730, 82618, 80541, 82579, 80505, 82513, 80459, 81824, 80390, 80361, 82123, 80302, 85830, 82080, 89019, 
                          82031, 89249, 87523, 89429, 90364, 90509, 90505, 90492, 90190, 89908, 89610, 89354, 89705, 89334, 89806, 89304, 88845, 89301, 89229, 89157, 89209, 89265, 
                          88694, 89495, 88658, 89603, 89462, 89672, 89104, 88927, 89193, 89127, 89075, 88537, 89199, 89482, 89134, 88593, 89482, 88570, 90420, 89442, 90558, 90587, 
                          90669, 91073, 91007, 90860, 91060, 90725, 90558, 90584, 90141, 90056, 89810, 89836, 89226, 88947, 88898, 89318, 89295, 89072, 89114, 88638, 88632, 88901, 
                          88540, 88901, 87799, 81132, 87772, 81109, 87769, 81152, 81214, 86434, 81283, 89938, 87467, 86450, 81283, 89915, 89902, 90033, 89905, 90072, 90056, 90968, 
                          90016, 91841, 91486, 91801, 91657, 91470, 91480, 90883, 90787, 90945, 90548, 91545, 90863, 91585, 90912, 91850, 91867, 91798, 92523, 91755, 92520, 92671, 
                          91975, 91401, 92605, 92073, 91191, 92093, 90663, 91680, 91227, 91693, 91765, 91496, 91125, 91877, 91447, 90620, 90653, 90656, 90348, 91053, 90367, 92979, 
                          91115, 92933, 91834, 91063, 92861, 92605, 91801, 93593, 92530, 92142, 92762, 92497, 93035, 92782, 92464, 92110, 92779, 92408, 92802, 93176, 92162, 93153, 
                          92136, 93173, 92047, 92028, 91644, 91978, 91453, 91585, 91818, 90935, 81932, 91867, 90620, 91959, 93232, 92014, 93225, 93202, 92339, 93068, 92589, 93045, 
                          92638, 92467, 87326, 93091, 92605, 92976, 93566, 92900, 93301, 91496, 92674, 91903, 92677, 91939, 92684, 92621, 92579, 92500, 92096, 92575, 92162, 92575, 
                          92201, 91014, 93655, 92228, 91545, 93684, 90978, 90308, 93632, 94639, 93622, 95554, 94642, 94662, 95463, 95167, 94344, 95174, 94298, 94695, 94715, 94652, 
                          94278, 93934, 92946, 92579, 93419, 93717, 93711, 93671, 92907, 92946, 92972, 92205, 92972, 92231, 94341, 92969, 94573, 93835, 93002, 94531, 95374, 94482, 
                          94216, 93825, 95472, 94472, 94423, 95833, 95666, 96411, 96286, 96086, 97559, 97303, 96056, 97657, 97241, 97156, 98110, 97539, 97060, 97707, 97661, 97759, 
                          97231, 97470, 97500, 97113, 97221, 96447, 96512, 96512, 95915, 95919, 96004, 96020, 96145, 96217, 96306, 96355, 94475, 94446, 98330, 97047, 98304, 97028, 
                          98228, 97047, 98947, 98540, 98081, 98481, 98163, 98530, 97907, 97910, 97913, 97913, 97382, 97454, 96864, 97493, 97503, 97133, 97149, 96309, 97169, 96240, 
                          98625, 97815, 96070, 98599, 98058, 97762, 98868, 98002, 98802, 98740, 98688, 99052, 99012, 99514, 98970, 98107, 99452, 98894, 98074, 97887, 98369, 97687, 
                          98947, 98409, 97680, 98422, 98455, 98891, 97635, 98924, 97448, 98031, 97461, 97457, 96801, 99229, 98156, 96831, 99157, 98192, 99117, 98035, 99485, 98402, 
                          99488, 98743, 99396, 98691, 99242, 98638, 98599, 97805, 98606, 97815, 98553, 97730, 97749, 97093, 97753, 97067, 98258, 96906, 98035, 96450, 99731, 98999, 
                          98373, 99642, 98934, 99596, 100778, 99524, 100676, 99770, 100554, 99662, 101273, 100509, 102159, 101588, 101785, 101552, 101447, 101306, 101191, 101299, 100876, 
                          100968, 100394, 100394, 100377, 100430, 99849, 100515, 101476, 100522, 101699, 101906, 101867, 101647, 101404, 101430, 101181, 100673, 100676, 100564, 100541, 100594, 
                          99852, 100558, 99898, 100554, 99826, 100571, 99803, 100646, 100689, 99879, 100856, 101473, 100784, 101404, 101319, 101722, 101650, 101585, 101558, 101545, 101942, 
                          101919, 101952, 101890, 101811, 101719, 101654, 101358, 101302, 102221, 101339, 102152, 101368, 101946, 101742, 101381, 101877, 101873, 101929, 101942, 101982, 101808, 
                          101834, 101762, 101745, 101680, 101906, 102487, 101886, 101936, 101260, 101870, 101598, 101562, 101211, 101421, 101381, 101457, 100945, 101467, 100538, 100505, 100459, 
                          100413, 99741, 100361, 99793, 99816, 99167, 99856, 99127, 99849, 99852, 99449, 99068, 99501, 99068, 99941, 99521, 99928, 99521, 98173, 99419, 98153, 99406,
                          98084, 99373, 98071, 99482, 97897, 99383, 98668, 99646, 99626, 98606, 97500, 99573, 97513, 96827, 99626, 96637, 99692, 99688, 99626, 99626, 97687, 97297, 
                          99341, 97664, 99344, 97684, 99341, 97487, 98556, 97428, 98524, 98189, 98182, 98150, 98186, 98196, 97507, 97480, 97490, 99833, 97940, 97359, 96677, 97979, 
                          96719, 98291, 96719, 98835, 98284, 96759, 98829, 98258, 96654, 99547, 98865, 96388, 99921, 99554, 99888, 99577, 96450, 96575, 98599, 96581, 98661, 97772,
                          98675, 96952, 98579, 96880, 98924, 98510, 96873, 99541, 98930, 96847, 99567, 98960, 96896, 99596, 99547, 98776, 99511, 98737, 99491, 99055, 99196, 100243, 
                          99219, 99131, 99560, 99154, 99590, 101532, 100016, 99616, 98806, 101480, 100571, 99977, 102136, 101430, 100568, 102142, 102654, 102589, 102805, 102323, 102254, 
                          101883, 102651, 101877, 102717, 102254, 101798, 102782, 102398, 101972, 102402, 102480, 101260, 102503, 101224, 100696, 101781, 100728, 101762, 101358, 100791, 103100, 
                          101690, 103009, 101742, 102963, 101801, 103287, 102904, 103251, 103684, 103527, 103465, 103274, 103182, 102881, 102680, 102621, 101755, 102644, 101857, 102700, 102034, 
                          102054, 103097, 102028, 101276, 103114, 102572, 102090, 103609, 102546, 104098, 103553, 102497, 104715, 104055, 103514, 104669, 104613, 105197, 104616, 105157, 105128, 
                          105157, 104829, 104948, 105039, 104610, 104557, 104199, 104177, 103622, 103930, 103976, 103996, 103524, 104154, 103445, 103304, 104209, 103816, 103182, 104140, 104075, 
                          104045, 104865, 104140, 104810, 104738, 104754, 105030, 104957, 104508, 104583, 104577, 104662, 104682, 104360, 104403, 104551, 103825, 104826, 104833, 104895, 104875,
                          104560, 103612, 104596, 103018, 104636, 100180, 103642, 102448, 103638, 102917, 103655, 102927, 103638, 102474, 101680, 104154, 103665, 104747, 104173, 103704, 104711,
                          104091, 104649, 104078, 104587, 104843, 104501, 104931, 104879, 104787, 105085, 104833, 104462, 104245, 104239, 104659, 104760, 104409, 104865, 104360, 105144, 104619,
                          104373, 105089, 104652, 105013, 103996, 104977, 104452, 103963, 105791, 104954, 104432, 106201, 105758, 104429, 106171, 106119, 105167, 106093, 105121, 105098, 105075,
                          105899, 105049, 105876, 105886, 106050, 106073, 105525, 106385, 105502, 106516, 105443, 105118, 105092, 105095, 104341, 104350, 103114, 104347, 104373, 104390, 104436,
                          104429, 103327, 101086, 104475, 103353, 104485, 103451, 101145, 104469, 103481, 104446, 103999, 104429, 103993, 104400, 104429, 105023, 104426, 105003, 106585 ];
            UInt16[] intensity = [ 30967, 41275, 19614, 35827, 30181, 17146, 31751, 33358, 17050, 32708, 40605, 16291, 40799, 39069, 34422, 24136, 34562, 49366, 45667, 20066, 43405, 45051,
                                   43769, 28159, 42160, 44390, 29410, 38605, 38433, 38200, 38571, 18938, 39380, 23706, 34886, 29581, 30482, 38729, 40268, 39970, 20997, 26464, 25165, 42764,
                                   41232, 46230, 17737, 41222, 44381, 43273, 36660, 32637, 40196, 27223, 23516, 17382, 25062, 25837, 24890, 33429, 32991, 38191, 19302, 27030, 33600, 18231,
                                   20209, 19502, 15295, 31276, 21975, 35237, 19743, 33836, 28382, 21515, 16499, 32198, 35547, 18701, 18832, 21380, 32894, 34024, 17531, 38698, 23349, 19947,
                                   27504, 31549, 19868, 16317, 39383, 17923, 16405, 15173, 33751, 39114, 27631, 36104, 21012, 30652, 30066, 30233, 24303, 20244, 31151, 18902, 17877, 28538,
                                   31955, 38637, 32942, 31935, 33129, 29574, 25563, 36007, 23742, 35198, 27028, 35215, 44893, 20991, 44589, 48165, 43805, 49908, 47763, 31678, 41208, 49700,
                                   27983, 41151, 32479, 36027, 20506, 50021, 47337, 47159, 46540, 19768, 43473, 24416, 35672, 38776, 15735, 47091, 44381, 39779, 32409, 32555, 41597, 20038,
                                   27569, 32321, 34330, 29833, 41437, 43302, 44760, 37044, 44573, 41227, 39580, 41267, 39272, 21606, 22850, 36412, 21524, 45884, 40020, 44582, 43146, 38672,
                                   32848, 30372, 40147, 32358, 37910, 35003, 32752, 30562, 41651, 42667, 41657, 16408, 44417, 29350, 27113, 42762, 30718, 37222, 30168, 29052, 44365, 42068,
                                   40213, 38840, 42180, 42220, 25760, 35199, 44415, 44412, 44324, 45579, 44286, 46666, 27528, 26596, 35833, 41697, 39404, 43739, 44450, 31439, 26433, 39876,
                                   19736, 41036, 42877, 30513, 41269, 33165, 26105, 42633, 43581, 25430, 40476, 33174, 23980, 23968, 27070, 46877, 45298, 39478, 21197, 44686, 45639, 27188,
                                   32713, 35460, 23304, 40109, 38898, 45018, 37658, 24656, 38812, 34092, 19705, 28891, 34424, 39283, 24440, 39052, 40926, 38190, 31103, 29464, 38012, 30999,
                                   29474, 19718, 20905, 40308, 17290, 31637, 19683, 28659, 34294, 44534, 39969, 40793, 22830, 23932, 28700, 36181, 48182, 42610, 43169, 37781, 34974, 20502,
                                   41767, 42817, 20262, 15377, 30548, 32117, 27383, 32188, 37930, 24317, 27604, 36353, 34374, 28852, 33107, 19998, 39486, 33765, 41330, 41955, 25650, 37785,
                                   30834, 33433, 25924, 28009, 38048, 24884, 30257, 34654, 19324, 24873, 26363, 39575, 18432, 45852, 26658, 38221, 47688, 45186, 21422, 32178, 34538, 28901,
                                   36172, 41337, 28148, 30117, 37512, 38167, 37524, 19763, 39421, 14657, 39200, 27850, 45722, 21025, 44737, 46260, 44594, 35245, 27144, 39051, 20733, 22130,
                                   36130, 24366, 25739, 34578, 17800, 37949, 23949, 14796, 45101, 18420, 43909, 21416, 37483, 34531, 33991, 24959, 19661, 40298, 30476, 40751, 43400, 40871,
                                   40720, 30588, 26137, 14994, 40010, 45497, 44513, 24705, 39927, 45106, 43256, 19306, 39948, 22430, 31083, 34138, 28829, 21499, 29011, 38721, 24594, 38277,
                                   31238, 22599, 28636, 36668, 18321, 38079, 44017, 39639, 41524, 37070, 28672, 26250, 25543, 25267, 30841, 28731, 20583, 31947, 14260, 37533, 41408, 30169,
                                   29942, 40706, 22293, 34090, 19096, 38341, 41492, 36010, 33227, 43741, 46890, 43850, 42111, 42879, 44777, 32916, 36220, 38009, 39312, 26038, 40177, 21123,
                                   31960, 28300, 36699, 39917, 40458, 28868, 38157, 40212, 42643, 44727, 44577, 31320, 34876, 37997, 28511, 42908, 39778, 20028, 41414, 32066, 36138, 34424,
                                   20265, 20001, 21120, 23483, 29036, 23400, 32546, 32406, 42559, 42325, 39527, 43042, 43015, 23016, 36106, 33582, 25968, 23778, 34626, 41402, 21047, 38467,
                                   32707, 32124, 20206, 45855, 41889, 29193, 31973, 34194, 33506, 29556, 38091, 27426, 31916, 33690, 30200, 26520, 29524, 29659, 28216, 32173, 27381, 37028,
                                   41887, 18204, 40016, 26280, 28350, 37066, 36741, 33705, 29679, 36950, 26227, 38981, 41034, 24166, 32632, 28993, 27498, 18667, 40145, 18612, 21660, 35004,
                                   30049, 42191, 26935, 43951, 35992, 36329, 40646, 27104, 41727, 19516, 39048, 21026, 27925, 32379, 40792, 38873, 41502, 38146, 42414, 34480, 21586, 22113,
                                   39853, 44261, 43606, 37941, 17016, 45261, 17391, 36204, 41501, 40828, 34605, 43498, 43725, 38509, 43174, 42677, 43629, 41820, 43787, 39313, 20575, 23378,
                                   40529, 43812, 22750, 41874, 20755, 45888, 43530, 20091, 41550, 23448, 37116, 44811, 42672, 48120, 45950, 48040, 46760, 42977, 45536, 47830, 40886, 48396,
                                   48014, 46799, 45910, 44056, 44059, 42109, 29608, 21946, 43367, 30064, 18224, 23704, 40971, 45439, 46059, 46414, 47483, 44457, 40611, 49165, 48600, 45327,
                                   44891, 22741, 26453, 22992, 27276, 37593, 45299, 41577, 37731, 47693, 44061, 33062, 19072, 36218, 35696, 48447, 48717, 45979, 13027, 37016, 28929, 37773,
                                   24598, 45335, 14383, 44977, 36486, 24067, 18228, 41309, 26419, 28852, 41694, 27154, 38297, 25445, 41551, 33876, 35087, 36680, 44949, 18628, 45088, 17807,
                                   40716, 20158, 45192, 30835, 32732, 31449, 41294, 16165, 31739, 34318, 37531, 42117, 44410, 44652, 40748, 23058, 20080, 40949, 33276, 39697, 32171, 23252,
                                   39692, 38208, 36211, 28856, 27095, 39754, 42586, 39246, 26375, 42307, 41771, 34561, 15609, 32767, 28315, 21934, 42296, 29823, 33780, 33963, 20689, 35627,
                                   25708, 31800, 21449, 36022, 32547, 38350, 25318, 30610, 34243, 41246, 34597, 43362, 42011, 40422, 28724, 44616, 17936, 42469, 17969, 40957, 29800, 24426,
                                   38846, 22889, 24823, 35238, 24498, 36021, 28323, 22528, 41439, 40012, 24493, 41921, 18300, 27980, 28044, 37773, 23600, 39170, 42125, 28865, 36731, 40717,
                                   25937, 29810, 29395, 19867, 38779, 18475, 20756, 27317, 40689, 14543, 40393, 42168, 37675, 33486, 40286, 35762, 39812, 26673, 33973, 27561, 20865, 27395,
                                   33602, 15759, 22883, 40989, 39671, 16950, 17684, 29880, 23904, 27601, 31050, 30640, 18905, 26874, 33095, 33117, 32833, 32040, 31257, 25153, 33464, 28401,
                                   41509, 40491, 40949, 37021, 44572, 41391, 44334, 39016, 41195, 16658, 42533, 26271, 38029, 31141, 44544, 23131, 31021, 27744, 28312, 33926, 18027, 33455,
                                   33302, 25939, 37361, 18083, 23088, 28414, 27027, 40101, 42934, 28022, 31822, 42680, 44469, 44972, 40768, 45703, 31485, 32026, 36497, 32505, 45345, 18787,
                                   40061, 42201, 21168, 37977, 17431, 42600, 44457, 17127, 18023, 38478, 42125, 44214, 40760, 39651, 22342, 46476, 41447, 47254, 38950, 33176, 35625, 47087,
                                   43452, 42521, 39599, 42990, 44416, 39220, 21375, 38482, 41162, 41096, 40621, 35074, 14328, 37811, 18872, 36527, 17190, 38661, 16801, 22574, 25968, 26951,
                                   33413, 35799, 21354, 15162, 18777, 42051, 30555, 29260, 17621, 41311, 23100, 39855, 22177, 44805, 29055, 35963, 41261, 39030, 40913, 17385, 20771, 35219,
                                   39793, 41550, 38954, 33523, 31436, 35808, 32691, 25865, 16524, 30604, 35342, 26470, 39726, 30602, 38537, 30953, 14936, 22742, 14766, 42273, 36858, 26200,
                                   23297, 40911, 38800, 30982, 28345, 41143, 36646, 42396, 25588, 38793, 46114, 39022, 41332, 39751, 20670, 28167, 33689, 30717, 27676, 28178, 43580, 37503,
                                   33303, 35446, 17642, 43697, 45214, 45956, 46250, 41870, 22119, 19557, 43981, 19644, 40554, 23925, 31793, 45887, 15283, 43564, 17327, 42344, 19560, 45086,
                                   44844, 21621, 40406, 35027, 38087, 18566, 36857, 27880, 38626, 41138, 44271, 43612, 26975, 34753, 42495, 24262, 22471, 16085, 39484, 16851, 43654, 43896,
                                   42942, 43860, 23931, 38381, 27232, 45174, 16714, 45772, 45625, 46401, 43873, 17562, 22488, 37621, 40950, 15309, 43634, 15113, 41849, 35864, 37315, 21557 ];
            #endregion
            z.RandomizeOrder();
            intensity.RandomizeOrder();

            // unscaled z sort: Int32
            Span<int> dataLengths = [ 0, 1, 2, 3, 4, 5, 7, 8, 9, 16, 32, 64, 99, 128, 226, 256, 512, 607, z.Length ];
            for (int dataLengthIndex = 0; dataLengthIndex < dataLengths.Length; ++dataLengthIndex)
            {
                int dataLength = dataLengths[dataLengthIndex];
                Int32[] introspectiveSort = new Int32[dataLength];
                Array.Copy(intensity, 0, introspectiveSort, 0, dataLength);
                Array.Sort(introspectiveSort);

                Int32[] radixSort = new Int32[dataLength];
                Int32[] radixWorkingBuffer = new Int32[dataLength + 1];
                Array.Copy(intensity, 0, radixSort, 0, dataLength);
                SpanExtensions.SortRadix256(radixSort, radixWorkingBuffer);

                for (int index = 0; index < introspectiveSort.Length; ++index)
                {
                    Assert.IsTrue(introspectiveSort[index] == radixSort[index]);
                }
            }

            // intensity sort: UInt16
            dataLengths[^1] = intensity.Length;
            for (int dataLengthIndex = 0; dataLengthIndex < dataLengths.Length; ++dataLengthIndex)
            {
                int dataLength = dataLengths[dataLengthIndex];
                UInt16[] introspectiveSort = new UInt16[dataLength];
                Array.Copy(intensity, 0, introspectiveSort, 0, dataLength);
                Array.Sort(introspectiveSort);

                UInt16[] radixSort = new UInt16[dataLength];
                UInt16[] radixWorkingBuffer = new UInt16[dataLength + 7];
                Array.Copy(intensity, 0, radixSort, 0, dataLength);
                SpanExtensions.SortRadix256(radixSort, radixWorkingBuffer);

                for (int index = 0; index < introspectiveSort.Length; ++index)
                {
                    Assert.IsTrue(introspectiveSort[index] == radixSort[index]);
                }
            }
        }
    }
}
